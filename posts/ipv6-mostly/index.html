<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml><head><meta charset=UTF-8><meta content="...just stuff I thought I should write down and that might be useful to others..." name=description><meta content="width=device-width,initial-scale=1" name=viewport><meta content=#ff7800 name=theme-color><meta content=#ffa348 media=(prefers-color-scheme:dark) name=theme-color><title>IPv6, Mostly... - Karl's Little World</title><link href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/ rel=canonical><link href=https://mastodon.social/@karldyson rel=me><meta content=@karldyson@mastodon.social name=fediverse:creator><link href=https://karldyson.github.io/karld-blog-website/favicon.png rel=icon type=image/png><link href=https://karldyson.github.io/karld-blog-website/apple-touch-icon.png rel=apple-touch-icon sizes=180x180 type=image/png><link title="Karl's Little World - Atom Feed" href=https://karldyson.github.io/karld-blog-website/atom.xml rel=alternate type=application/atom+xml><link title="Karl's Little World - RSS Feed" href=https://karldyson.github.io/karld-blog-website/rss.xml rel=alternate type=application/rss+xml><style>:root{--accent-color:#ff7800}[data-theme=dark]{--accent-color:#ffa348}@media (prefers-color-scheme:dark){:root:not([data-theme=light]){--accent-color:#ffa348}}</style><link href=https://karldyson.github.io/karld-blog-website/style.css rel=stylesheet><link media="(prefers-color-scheme: light)" href=https://karldyson.github.io/karld-blog-website/syntax-theme-light.css rel=stylesheet><link media="(prefers-color-scheme: dark)" href=https://karldyson.github.io/karld-blog-website/syntax-theme-dark.css rel=stylesheet><script defer src=https://karldyson.github.io/karld-blog-website/closable.js></script><script data-goatcounter=https://junesta.goatcounter.com/count defer src=https://karldyson.github.io/karld-blog-website/count.js></script><script defer src=https://karldyson.github.io/karld-blog-website/fuse.js></script><script defer src=https://karldyson.github.io/karld-blog-website/search-fuse.js></script><script defer src=https://karldyson.github.io/karld-blog-website/theme-switcher.js></script><meta content="Karl's Little World" property=og:site_name><meta content="IPv6, Mostly... - Karl's Little World" property=og:title><meta content=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/ property=og:url><meta content="...just stuff I thought I should write down and that might be useful to others..." property=og:description><meta content=https://karldyson.github.io/karld-blog-website/card.png property=og:image><meta content=en_US property=og:locale><body><header id=site-nav><nav><a href=#main-content tabindex=0> Skip to Main Content </a><ul><li id=home><a href=https://karldyson.github.io/karld-blog-website> <i class=icon></i>Karl's Little World</a><li class=divider><li><a href=https://karldyson.github.io/karld-blog-website/about/>About</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/>Posts</a><li id=search><button class=circle id=search-toggle title=Search><i class=icon></i></button><li id=theme-switcher><details class=closable><summary class=circle title=Theme><i class=icon></i></summary> <ul><li><button title="Switch to Light Theme" class=circle id=theme-light><i class=icon></i></button><li><button title="Switch to Dark Theme" class=circle id=theme-dark><i class=icon></i></button><li><button title="Use System Theme" class=circle id=theme-system><i class=icon></i></button></ul></details><li id=feed><details class=closable><summary class=circle title=Feed><i class=icon></i></summary> <ul><li><a href=https://karldyson.github.io/karld-blog-website/atom.xml>Atom</a><li><a href=https://karldyson.github.io/karld-blog-website/rss.xml>RSS</a></ul></details><li id=repo><a class=circle href=https://github.com/karldyson/karld-blog-website title=Repository> <i class=icon></i> </a></ul></nav><div id=search-container><label class=visually-hidden for=search-bar>Search</label><input placeholder="Search for…" autocomplete=off disabled id=search-bar type=search><div id=search-results-container><div id=search-results></div></div></div></header><main id=main-content><article><div id=heading><p><small> <time datetime=" 2025-04-26T00:00:00+00:00">Published on April 26, 2025</time></small><h1>IPv6, Mostly...</h1><p><small><span>11 minutes read</span><span> • </span></small><ul class=tags><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/dhcp/>dhcp</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/dns64/>dns64</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/ipv6/>ipv6</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/ipv6-mostly/>ipv6-mostly</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/juniper/>juniper</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/srx/>srx</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/junos/>junos</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/nat64/>nat64</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/rdnss/>rdnss</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/slaac/>slaac</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/option108/>option108</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/option-108/>option-108</a><li><a class=tag href=https://karldyson.github.io/karld-blog-website/tags/option-108/>option 108</a></ul></div><div id=buttons-container><details class=closable id=toc><summary title="Table of Contents"><i class=icon></i></summary> <div><strong class=title>Table of Contents</strong><div><ul><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#introduction>Introduction</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#privacy>Privacy?</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#network-address-translation-nat>Network Address Translation (NAT)</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#so-just-how-big-is-ipv6-to-not-need-nat>So just how big is IPv6 to not need NAT…?</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#back-to-privacy-then>Back to Privacy, then…</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#router-advertisements>Router Advertisements</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#nat64>NAT64</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#dns64>DNS64</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#customer-translator-clat>Customer Translator (CLAT)</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#dhcp-option-108>DHCP Option 108</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#so-lets-make-it-work>So, lets make it work…</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#configuration-time>Configuration Time</a><ul><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#nat>NAT</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#slaac-rdnss-and-pref64>SLAAC, RDNSS and PREF64</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#option-108>Option 108</a></ul><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#did-it-work>Did it work?</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#the-end>The End!</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#footnotes>Footnotes</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/#further-reading>Further Reading</a></ul></div></div></details><details class=closable id=backlinks><summary title=Backlinks><i class=icon></i></summary> <div><strong class=title>Backlinks</strong><div><ul><li><a href=https://karldyson.github.io/karld-blog-website/posts/things-ipv6-mostly-breaks-part-1/>Things IPv6 Mostly Breaks, Part 1</a></ul></div></div></details><a title="Go to Top" href=#top id=go-to-top><i class=icon></i></a><a href="https://shareopenly.org/share/?url=https://karldyson.github.io/karld-blog-website/posts/ipv6-mostly/" id=share title=Share><i class=icon></i></a><a title="File an Issue" href=https://github.com/karldyson/karld-blog-website/issues id=issue><i class=icon></i></a></div><blockquote class=warning><p class=alert-title><i class=icon></i>Warning<p><mark>TL;DR</mark>: This article turned out longer than expected, so if you just want the tl;dr, <a href=#configuration-time>skip to that bit</a>.</blockquote><h1 id=introduction>Introduction</h1><p>IPv4 has run out. This is not news.<p>IPv6 uptake, however, has been slow given it was first created in 1995.<p>It can be intimidating, if you’re not a network expert, and there are still things that are perceived to just work best if you’re doing IPv4.<p>Examples include getting information about the network to a client, other than the client’s IP address.<p>With IPv4, when you connect to a network, by default in most cases, your device asks the network for an IP address using a protocol called Dynamic Host Configuration Protocol (DHCP).<p>But the protocol doesn’t just give your device an IP address; it can also let your device know about a bunch of other things on the network. Most commonly the DNS servers that will resolve names for you, but also things like NTP servers, proxy discovery, and more can be conveyed to the device using this mechanism.<p>So IPv6 just needs a version of DHCP then? Well sure, and it does, cunningly named DHCPv6. But for lots of reasons, on a client network, you probably don’t want to be handing out IPv6 addresses with DHCPv6. IPv6 is more modern and can sort out its addresses statelessly and automatically using something called SLAAC. You probably want IPv6 to be stateless for a variety of reasons. Privacy is high up the list.<h1 id=privacy>Privacy?</h1><p>Let’s take a step back.<p>With IPv4, the address space is tiny compared to the number of devices on the modern internet. Think about your phones, iPads, laptops, home assistant, smart speakers; the list goes on. Even a modest modern home has dozens of devices needing an IP address.<p>So, there are blocks of IPv4 addresses reserved for use within private networks that will never be routed on the internet. Those private addresses can be routinely used in many networks concurrently because whilst IP addresses have to be unique, they only have to be unique within a given network.<p>Your device gets one of those private addresses.<p>But, how do you communicate on the internet if your device has an IP address that doesn’t work on the internet?<h1 id=network-address-translation-nat>Network Address Translation (NAT)</h1><p>When your device makes a connection to something on the internet, your router does something called Network Address Translation (NAT).<p>That is to say, on the inside of your network there will be plenty of those private addresses for all of the devices, but your router will map them all onto a much smaller pool of internet routable addresses and then juggle making sure the right internet traffic is sent to the right device.<p>This means that it’s harder for websites to track you using your IP address, because a whole bunch of devices and users will be “hidden” behind a much smaller NAT pool, possibly just a single IP.<p>With IPv6, the size of the address space is vast. There’s no need for NAT and so the IP address your machine has, is the IP that things you connect to on the internet see. For example when you browse a website.<p>Instead of all devices on a network being hidden behind one IP, every individual device has a real internet IP address.<p>This makes it a lot easier for websites to use your IP address to track you, if your IP address is now per device.<h1 id=so-just-how-big-is-ipv6-to-not-need-nat>So just how big is IPv6 to not need NAT…?</h1><p>Won’t we run out? We did with IPv4 after all…<p>IPv4 has a total of 232 IP addresses. That’s 4,294,967,296. Four billion and change. Sounds like a lot, right?<p>IPv6 has a total of 2128 IP addresses.<p>That’s 340,282,366,920,938,463,463,374,607,431,768,211,456<p>340 trillion trillion trillion.<p>For context, that’s more than 100 times the number of atoms on the surface of the Earth<sup class=footnote-reference id=fr-1-1><a href=#fn-1>1</a></sup>.<p>It was calculated that we could assign a unique /48 to every human being on Earth for the next 480 years before we would run out.<p>A /48 is the expected common assignment block size. It’s what my ISP has assigned me for my home network. It’s the smallest block of IPv6 address space that you can route on the wider internet.<p>Your typical individual network subnet will be assigned a /64.<p>A /48 contains 65,536 /64 subnets.<p>A /64 network contains 18,446,744,073,709,551,616 usable IPv6 addresses.<h1 id=back-to-privacy-then>Back to Privacy, then…</h1><p>So, IPv6 has the concept of Privacy Extensions (<a href=https://datatracker.ietf.org/doc/html/rfc8981>RFC8981</a>) which means that it has a mechanism for your device to assign itself new IP addresses temporarily, use them for a while, and then discard them. But it requires that your network is assigning addresses statelessly.<h1 id=router-advertisements>Router Advertisements</h1><p>If you’re doing stateless IPv6 addresses, and you want to move away from using IPv4, how do you tell your devices about things like DNS resolvers?<p>In order to statelessly configure its IPv6 addresses, your device sends something called Router Solicitation (RS) messages to the network. Available routers on the network respond with Router Advertisement (RA) messages.<p>These RAs include the network prefix(es) in use so SLAAC and privacy extensions can work. They can also be used to tell the client device whether to actually use stateless addresses, whether to try DHCPv6, or whether to do a bit of both, and use stateless addresses but with other information (like DNS servers) from DHCPv6.<p>More recently, to avoid the need for DHCPv6 at all, these RAs can now contain the DNS server information (RDNSS).<p>OK, so we’ll switch off IPv4 inside our networks? We’ll give all the clients an IPv6 address.<p>We can use the RA to give devices DNS servers.<p>But what about things on the internet that are still only configured for IPv4…?<p>How do you connect to them?<h1 id=nat64>NAT64</h1><p>In a similar way to how NAT works above, translating networks of private addresses into a smaller pool of internet routable addresses, it’s possible to translate addresses between address families: ie: between IPv4 and IPv6.<p>Your router can tell your device that the network has the ability to do NAT64.<p>With this, devices connect to a mapped IPv6 address for any internet device that only has IPv4.<p>There’s what’s called a well-known allocation for NAT64: <code>64:ff9b::/96</code>.<p>This allows us to map the entire IPv4 address space. For example, let’s say your device wants to connect to a website that only has IPv4 and its address is <code>198.51.100.189</code>. This maps to <code>64:ff9b::c633:64bd</code>.<p>If you look carefully at the end of that, you can see we have <code>c633:64bd</code>.<p><code>c6</code> in hexadecimal is <code>198</code> in decimal.<p>Converting the rest, then: <code>33</code> becomes <code>51</code>, <code>64</code> becomes <code>100</code>, and <code>bd</code> becomes <code>189</code>.<p>Your device makes an IPv6 connection to <code>64:ff9b::c633:64bd</code> and when this reaches the router, it knows to translate this back the other way and make an IPv4 connection to <code>198.51.100.189</code>.<p>But how does the device know to attempt to connect to that mapped IPv6 address?<h1 id=dns64>DNS64</h1><p>One option is that you give them a DNS server that does DNS64.<p>Usually, dual stack devices will prefer IPv6. As such, when they do DNS lookups to get the IP address for whatever the device needs to connect to, they will look up an IPv6 (AAAA) DNS record first, and fall back to IPv4 (A record).<p>So, a DNS64 capable DNS server looks up the AAAA record. If it exists, it gives the response back to the device and everything works over IPv6.<p>However, if the AAAA record doesn’t exist, the service only supports IPv4, the DNS64 server looks up the IPv4 A record, but instead of telling the requesting device, the DNS64 server generates the relevant mapped NAT64 IP address and returns that in the AAAA record.<p>The device makes what it thinks is an IPv6 connection, and the NAT64 configuration on the router does the translation to IPv4.<p>Google offer public DNS64 servers on <code>2001:4860:4860::64</code> and <code>2001:4860:4860::6464</code><p>But, some components that run on your machine can decide to use DNS servers of their own choice. This can lead to some things not using a DNS64 server, not getting the mapped IP, and continuing to use IPv4 which may be undesirable.<h1 id=customer-translator-clat>Customer Translator (CLAT)</h1><p>A second method is a customer translator or CLAT.<p>Your device learns that the network can do NAT64 from the network itself. It learns what the prefix is and can do the mapping from the desired IPv4 address to IPv6 under the covers within the operating system.<p>Further, your applications don’t need to know that they’re not making an IPv4 connection.<p>Your device puts an unroutable placeholder IPv4 address on its network interface to keep up the pretence that IPv4 is working as usual.<p>When your application attempts to make an IPv4 connection, the CLAT within your device works out the mapping, and makes the IPv6 connection to the mapped IPv6 address. The router does NAT64 and it all works seamlessly.<p>This even works for IP literals.<h1 id=dhcp-option-108>DHCP Option 108</h1><p>So, how do we persuade devices that the network supports IPv6, and can do NAT64 for those pesky “IPv4 only” things?<p>Many devices still send out DHCP for IPv4 first.<p>So there’s a mechanism for saying “if you support CLAT, can use the network’s NAT64, and don’t want or need an IPv4 DHCP lease”.<p>It’s called “option 108”.<p>Devices capable of IPv6 mostly, will set option 108 in their DHCP request. If the DHCP server replies with option 108, the client doesn’t take an IPv4 lease and applies the placeholder/unroutable IPv4 address to the interface.<h1 id=so-lets-make-it-work>So, lets make it work…</h1><p>I wanted to tinker with this and see it in action.<p>My router/firewall was a Juniper SRX240 which sadly will not run a new enough version of Junos to support RDNSS.<p>It didn’t support telling the clients about the NAT64 prefix either, and it seemed very unhappy with me trying to persuade it to do DHCPv6 for just the DNS information.<p>So, this felt like a great excuse to finally replace it, and so now I have a SRX340 in its place.<p>The next thing to consider is client device support. My laptop is a MacBook, my family use iPhones and iPads. There’s the usual plethora of IoT things around the network too.<p>Your mileage may vary if you have other things around your network.<p>So I started with the guest VLAN as there’s less in there to disrupt.<p>I want stateless addresses. I need to configure router advertisements anyway, so I’d like to skip needing DHCPv6 configured.<h1 id=configuration-time>Configuration Time</h1><h2 id=nat>NAT</h2><p>First we’ll configure NAT64 so that when we tell the clients it’s available, it actually is. We need to do two things here:<ol><li><p>We need to take traffic destined for the NAT64 prefix and static NAT it to IPv4. You can see this in the static NAT section at the top of the following configuration snippet.</p><li><p>We need to then source NAT the traffic so that it comes from an internet routable IPv4 address. I’m fortunate here in that I have a /29 from my ISP, and so to aid troubleshooting, I have the NAT64 traffic SNAT from a different IP to the IPv4 native traffic.</p></ol><details><summary>Junos Configuration</summary> <pre class="language-Junos z-code" data-lang=Junos><code class=language-Junos data-lang=Junos><span class="z-text z-junos">security {
</span><span class="z-text z-junos">    nat {
</span><span class="z-text z-junos">        static {
</span><span class="z-text z-junos">            rule-set<span class="z-variable z-language z-junos"> nat64</span> {
</span><span class="z-text z-junos">                from zone guest;
</span><span class="z-text z-junos">                rule<span class="z-variable z-language z-junos"> nat64</span> {
</span><span class="z-text z-junos">                    match {
</span><span class="z-text z-junos"><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span>source-address<span class="z-constant z-numeric z-integer z-long z-octal z-junos"> 2001:db8:97::/64;</span>
</span><span class="z-text z-junos"><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span>destination-address<span class="z-constant z-numeric z-integer z-long z-octal z-junos"> 64:ff9b::/96;</span>
</span><span class="z-text z-junos">                    }
</span><span class="z-text z-junos">                    then {
</span><span class="z-text z-junos">                        static-nat {
</span><span class="z-text z-junos">                            inet;
</span><span class="z-text z-junos">                        }
</span><span class="z-text z-junos">                    }
</span><span class="z-text z-junos">                }
</span><span class="z-text z-junos">            }
</span><span class="z-text z-junos">        }
</span><span class="z-text z-junos">        source {
</span><span class="z-text z-junos">            pool<span class="z-variable z-language z-junos"> guest</span> {
</span><span class="z-text z-junos">                address {
</span><span class="z-text z-junos">                    <span class="z-constant z-numeric z-integer z-long z-octal z-junos">192.0.2.230/32</span>;
</span><span class="z-text z-junos">                }
</span><span class="z-text z-junos">            }
</span><span class="z-text z-junos">            pool<span class="z-variable z-language z-junos"> guest-nat64</span> {
</span><span class="z-text z-junos">                address {
</span><span class="z-text z-junos">                    <span class="z-constant z-numeric z-integer z-long z-octal z-junos">192.0.2.229/32</span>;
</span><span class="z-text z-junos">                }
</span><span class="z-text z-junos">            }
</span><span class="z-text z-junos">            rule-set<span class="z-variable z-language z-junos"> guest</span> {
</span><span class="z-text z-junos">                from zone guest;
</span><span class="z-text z-junos">                to zone untrust;
</span><span class="z-text z-junos">                rule<span class="z-variable z-language z-junos"> guest</span> {
</span><span class="z-text z-junos">                    match {
</span><span class="z-text z-junos">                        source-address <span class="z-constant z-numeric z-integer z-long z-octal z-junos">192.168.97.0/24</span>;
</span><span class="z-text z-junos">                    }
</span><span class="z-text z-junos">                    then {
</span><span class="z-text z-junos">                        source-nat {
</span><span class="z-text z-junos">                           <span class="z-entity z-name z-function z-junos"> pool</span> {
</span><span class="z-text z-junos">                                <span class="z-variable z-language z-junos">guest</span>;
</span><span class="z-text z-junos">                            }
</span><span class="z-text z-junos">                        }
</span><span class="z-text z-junos">                    }
</span><span class="z-text z-junos">                }
</span><span class="z-text z-junos">                rule<span class="z-variable z-language z-junos"> guest-nat64</span> {
</span><span class="z-text z-junos">                    match {
</span><span class="z-text z-junos"><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span>source-address<span class="z-constant z-numeric z-integer z-long z-octal z-junos"> 2001:db8:97::/64;</span>
</span><span class="z-text z-junos">                        destination-address <span class="z-constant z-numeric z-integer z-long z-octal z-junos">0.0.0.0/0</span>;
</span><span class="z-text z-junos">                    }
</span><span class="z-text z-junos">                    then {
</span><span class="z-text z-junos">                        source-nat {
</span><span class="z-text z-junos">                           <span class="z-entity z-name z-function z-junos"> pool</span> {
</span><span class="z-text z-junos">                                <span class="z-variable z-language z-junos">guest-nat64</span>;
</span><span class="z-text z-junos">                            }
</span><span class="z-text z-junos">                        }
</span><span class="z-text z-junos">                    }
</span><span class="z-text z-junos">                }
</span><span class="z-text z-junos">            }
</span><span class="z-text z-junos">        }
</span><span class="z-text z-junos">    }
</span><span class="z-text z-junos">}
</span></code></pre></details><h2 id=slaac-rdnss-and-pref64>SLAAC, RDNSS and PREF64</h2><p>Next we need to tell the SRX to do SLAAC, RDNSS and PREF64…<p>First, our interface needs an IPv6 address.<pre class="language-Junos z-code" data-lang=Junos><code class=language-Junos data-lang=Junos><span class="z-text z-junos">interfaces {
</span><span class="z-text z-junos">    <span class="z-support z-class z-junos">irb</span> {
</span><span class="z-text z-junos">        unit <span class="z-constant z-numeric z-integer z-long z-octal z-junos">197</span> {
</span><span class="z-text z-junos">            description <span class="z-string z-quoted z-double z-junos">Guest</span>;
</span><span class="z-text z-junos">            family inet {
</span><span class="z-text z-junos">                address <span class="z-constant z-numeric z-integer z-long z-octal z-junos">192.168.97.1/24</span>;
</span><span class="z-text z-junos">            }
</span><span class="z-text z-junos">            family inet6 {
</span><span class="z-text z-junos"><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span>address<span class="z-constant z-numeric z-integer z-long z-octal z-junos"> 2001:db8:97::1/64;</span>
</span><span class="z-text z-junos">            }
</span><span class="z-text z-junos">        }
</span><span class="z-text z-junos">    }
</span><span class="z-text z-junos">}
</span></code></pre><p>Next, SLAAC, RDNSS and PREF64.<p>Within the protocols router-advertisement section, we will use the following options:<ul><li><code>dns-server-address</code> option to set the RDNSS server(s)<li><code>nat-prefix</code> to set the PREF64 prefix</ul><pre class="language-Junos z-code" data-lang=Junos><code class=language-Junos data-lang=Junos><span class="z-text z-junos">protocols {
</span><span class="z-text z-junos">    router-advertisement {
</span><span class="z-text z-junos">        interface <span class="z-support z-class z-junos">irb.197</span> {
</span><span class="z-text z-junos">            preference high;
</span><span class="z-text z-junos">            max-advertisement-interval <span class="z-constant z-numeric z-integer z-long z-octal z-junos">20</span>;
</span><span class="z-text z-junos">            min-advertisement-interval <span class="z-constant z-numeric z-integer z-long z-octal z-junos">3</span>;
</span><span class="z-text z-junos">            other-stateful-configuration;
</span><span class="z-text z-junos">            solicit-router-advertisement-unicast;
</span><span class="z-text z-junos">            default-lifetime <span class="z-constant z-numeric z-integer z-long z-octal z-junos">9000</span>;
</span><span class="z-text z-junos"><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span>dns-server-address<span class="z-constant z-numeric z-integer z-long z-octal z-junos"> 2001:4860:4860::8888 </span>{
</span><span class="z-text z-junos">                lifetime <span class="z-constant z-numeric z-integer z-long z-octal z-junos">9000</span>;
</span><span class="z-text z-junos">            }
</span><span class="z-text z-junos"><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span>prefix<span class="z-constant z-numeric z-integer z-long z-octal z-junos"> 2001:db8:97::/64;</span>
</span><span class="z-text z-junos"><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span><span class="z-constant z-numeric z-integer z-long z-octal z-junos">  </span>nat-prefix<span class="z-constant z-numeric z-integer z-long z-octal z-junos"> 64:ff9b::/96 </span>{
</span><span class="z-text z-junos">                lifetime <span class="z-constant z-numeric z-integer z-long z-octal z-junos">18000</span>;
</span><span class="z-text z-junos">            }
</span><span class="z-text z-junos">        }
</span><span class="z-text z-junos">    }
</span><span class="z-text z-junos">}
</span></code></pre><h2 id=option-108>Option 108</h2><p>Lastly, we’ll support clients that support DHCP option 108 in our DHCP configuration.<pre class="language-Junos z-code" data-lang=Junos><code class=language-Junos data-lang=Junos><span class="z-text z-junos">access {
</span><span class="z-text z-junos">    address-assignment {
</span><span class="z-text z-junos">        family inet {
</span><span class="z-text z-junos">            network <span class="z-constant z-numeric z-integer z-long z-octal z-junos">192.168.97.0/24</span>;
</span><span class="z-text z-junos">            range r1 {
</span><span class="z-text z-junos">                low <span class="z-constant z-numeric z-integer z-long z-octal z-junos">192.168.97.128</span>;
</span><span class="z-text z-junos">                high <span class="z-constant z-numeric z-integer z-long z-octal z-junos">192.168.97.191</span>;
</span><span class="z-text z-junos">            }
</span><span class="z-text z-junos">            dhcp-attributes {
</span><span class="z-text z-junos">                maximum-lease-time <span class="z-constant z-numeric z-integer z-long z-octal z-junos">9000</span>;
</span><span class="z-text z-junos">                router {
</span><span class="z-text z-junos">                    <span class="z-constant z-numeric z-integer z-long z-octal z-junos">192.168.97.1</span>;
</span><span class="z-text z-junos">                }
</span><span class="z-text z-junos">                propagate-settings <span class="z-support z-class z-junos">irb.197</span>;
</span><span class="z-text z-junos">                option <span class="z-constant z-numeric z-integer z-long z-octal z-junos">108</span> unsigned-integer <span class="z-constant z-numeric z-integer z-long z-octal z-junos">9000</span>;
</span><span class="z-text z-junos">            }
</span><span class="z-text z-junos">        }
</span><span class="z-text z-junos">    }
</span><span class="z-text z-junos">}
</span></code></pre><h1 id=did-it-work>Did it work?</h1><p>This is from a MacBook running MacOS 15.<p>We can see that the RA contains the configured details.<pre class=z-code><code><span class="z-text z-plain">$ ipconfig getra en4
</span><span class="z-text z-plain">RA Received 04/25/2025 23:06:51 from fe80::cee1:9400:c55a:d430, length 96, hop limit 64, lifetime 9000s, reachable 0ms, retransmit 0ms, flags 0x48=[ other ], pref=high
</span><span class="z-text z-plain">	source link-address option (1), length 8 (1): cc:e1:94:5a:d4:30
</span><span class="z-text z-plain">	rdnss option (25), length 24 (3):  lifetime 9000s, addr: 2001:4860:4860::8888
</span><span class="z-text z-plain">	prefix info option (3), length 32 (4):  2001:db8:97::/64, flags [ onlink auto ], valid time 2592000s, pref. time 604800s
</span><span class="z-text z-plain">	pref64 option (38), length 16 (2): 64:ff9b::/96 lifetime 18000s
</span></code></pre><p>We can see that the interface has stateless IPv6 configured, including privacy extensions. It has also enabled CLAT46, and has added the ‘placeholder’ IPv4 address.<pre class=z-code><code><span class="z-text z-plain">$ ifconfig en4
</span><span class="z-text z-plain">en4: flags=88e3&lt;UP,BROADCAST,SMART,RUNNING,NOARP,SIMPLEX,MULTICAST> mtu 1500
</span><span class="z-text z-plain">	options=6464&lt;VLAN_MTU,TSO4,TSO6,CHANNEL_IO,PARTIAL_CSUM,ZEROINVERT_CSUM>
</span><span class="z-text z-plain">	ether a0:ce:c8:dd:5b:74
</span><span class="z-text z-plain">	inet6 fe80::454:7b3a:963b:7fab%en4 prefixlen 64 secured scopeid 0xd
</span><span class="z-text z-plain">	inet6 2001:db8:97:8ea:22c2:54cd:a385 prefixlen 64 autoconf secured
</span><span class="z-text z-plain">	inet6 2001:db8:97:a4ba:e260:2aa1:59c0 prefixlen 64 deprecated autoconf temporary
</span><span class="z-text z-plain">	inet6 2001:db8:97:479:67b7:1474:4197 prefixlen 64 deprecated autoconf temporary
</span><span class="z-text z-plain">	inet 192.0.0.2 netmask 0xffffffff broadcast 192.0.0.2
</span><span class="z-text z-plain">	inet6 2001:db8:97:e9bf:52f3:939c:6a03 prefixlen 64 autoconf temporary
</span><span class="z-text z-plain">	inet6 2001:db8:97:2:c078:2867:d6d prefixlen 64 clat46
</span><span class="z-text z-plain">	nat64 prefix 64:ff9b:: prefixlen 96
</span><span class="z-text z-plain">	nd6 options=201&lt;PERFORMNUD,DAD>
</span><span class="z-text z-plain">	media: autoselect (1000baseT &lt;full-duplex>)
</span><span class="z-text z-plain">	status: active
</span></code></pre><p>The device thinks it has an IPv4 connection to something in Microsoft…<pre class=z-code><code><span class="z-text z-plain">$ netstat -f inet -an|grep ESTAB|grep 192.0
</span><span class="z-text z-plain">tcp4       0      0  192.0.0.2.51079        52.123.128.14.443      ESTABLISHED
</span><span class="z-text z-plain">&lt;snip>
</span></code></pre><p>What does the firewall have to say about that….?<pre class=z-code><code><span class="z-text z-plain">kdyson@er> show security flow session destination-prefix 52.123.128.14
</span><span class="z-text z-plain">Total sessions: 0
</span></code></pre><p>…but <code>52.123.128.14</code> maps to <code>64:ff9b::347b:800e</code> so lets check again…<pre class=z-code><code><span class="z-text z-plain">kdyson@er> show security flow session destination-prefix 64:ff9b::347b:800e
</span><span class="z-text z-plain">Session ID: 115964145637, Policy name: web-browsing/10, Timeout: 1778, Session State: Valid
</span><span class="z-text z-plain">  In: 2001:db8:97:8ab:f46e:f285:917f/51062 --> 64:ff9b::347b:800e/443;tcp, Conn Tag: 0x0, If: irb.197, Pkts: 29, Bytes: 11041,
</span><span class="z-text z-plain">  Out: 52.123.128.14/443 --> 192.0.2.229/18910;tcp, Conn Tag: 0x0, If: pp0.2, Pkts: 24, Bytes: 8486,
</span><span class="z-text z-plain">Total sessions: 1
</span></code></pre><p>The IP details have been redacted/sanitised, of course, but note that the SNAT IP is the guest-nat64 pool IP and not the regular guest pool IP.<h1 id=the-end>The End!</h1><p>Well, that turned out a bit longer than expected and has a couple of tangents along the way. If you stuck around for all of it, well done and thanks.<p>I hope it’s been useful or interesting!<h1 id=footnotes>Footnotes</h1><h1 id=further-reading>Further Reading</h1><ul><li><a href=https://www.ietf.org/archive/id/draft-link-v6ops-6mops-01.html>https://www.ietf.org/archive/id/draft-link-v6ops-6mops-01.html</a><li><a href=https://2023.apricot.net/assets/files/APPS314/apnic55-deployingipv_1677492529.pdf>https://2023.apricot.net/assets/files/APPS314/apnic55-deployingipv_1677492529.pdf</a><li><a href=https://blog.apnic.net/2019/06/07/how-to-slaac-dhcpv6-on-juniper-vsrx/>https://blog.apnic.net/2019/06/07/how-to-slaac-dhcpv6-on-juniper-vsrx/</a></ul><section class=footnotes><ol class=footnotes-list><li id=fn-1><p><a href=https://www.internetsociety.org/deploy360/ipv6/faq>Internet Society IPv6 FAQ</a> <a href=#fr-1-1>↩</a></p></ol></section></article><hr><nav id=post-nav><a class="post-nav-item post-nav-prev" href=https://karldyson.github.io/karld-blog-website/posts/nintendo-switch-nat-types/> <div class=nav-arrow>Previous</div> <span class=post-title>Nintendo Switch NAT Types</span> </a><a class="post-nav-item post-nav-next" href=https://karldyson.github.io/karld-blog-website/posts/ipv6-privacy-extensions-linux/> <div class=nav-arrow>Next</div> <span class=post-title>IPv6 Privacy Extensions on Linux</span> </a></nav><span class=hidden id=search-index>https://karldyson.github.io/karld-blog-website/search_index.en.json</span><span class=hidden id=more-matches-text>$MATCHES more matches</span></main><footer id=site-footer><nav><ul><li><a href=https://karldyson.github.io/karld-blog-website/about/>About</a><li><a href=https://karldyson.github.io/karld-blog-website/posts/>Posts</a><li><a href=https://karldyson.github.io/karld-blog-website/archive/>Archive</a><li><a href=https://karldyson.github.io/karld-blog-website/latest-posts/>Latest Posts</a></ul></nav><p>© Karl Dyson, 2010-2026. All rights reserved.<ul id=socials><li><a rel=" me" href=https://github.com/karldyson/ title=GitHub> <i style="--icon:url(&#34;data:image/svg+xml,%3Csvg role='img' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Ctitle%3EGitHub%3C/title%3E%3Cpath d='M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12'/%3E%3C/svg%3E&#34;)" class=icon></i> <span>GitHub</span> </a><li><a rel=" me" href=https://instagram.com/karlddyson/ title=Instagram> <i style="--icon:url(&#34;data:image/svg+xml,%3Csvg role='img' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Ctitle%3EInstagram%3C/title%3E%3Cpath d='M7.0301.084c-1.2768.0602-2.1487.264-2.911.5634-.7888.3075-1.4575.72-2.1228 1.3877-.6652.6677-1.075 1.3368-1.3802 2.127-.2954.7638-.4956 1.6365-.552 2.914-.0564 1.2775-.0689 1.6882-.0626 4.947.0062 3.2586.0206 3.6671.0825 4.9473.061 1.2765.264 2.1482.5635 2.9107.308.7889.72 1.4573 1.388 2.1228.6679.6655 1.3365 1.0743 2.1285 1.38.7632.295 1.6361.4961 2.9134.552 1.2773.056 1.6884.069 4.9462.0627 3.2578-.0062 3.668-.0207 4.9478-.0814 1.28-.0607 2.147-.2652 2.9098-.5633.7889-.3086 1.4578-.72 2.1228-1.3881.665-.6682 1.0745-1.3378 1.3795-2.1284.2957-.7632.4966-1.636.552-2.9124.056-1.2809.0692-1.6898.063-4.948-.0063-3.2583-.021-3.6668-.0817-4.9465-.0607-1.2797-.264-2.1487-.5633-2.9117-.3084-.7889-.72-1.4568-1.3876-2.1228C21.2982 1.33 20.628.9208 19.8378.6165 19.074.321 18.2017.1197 16.9244.0645 15.6471.0093 15.236-.005 11.977.0014 8.718.0076 8.31.0215 7.0301.0839m.1402 21.6932c-1.17-.0509-1.8053-.2453-2.2287-.408-.5606-.216-.96-.4771-1.3819-.895-.422-.4178-.6811-.8186-.9-1.378-.1644-.4234-.3624-1.058-.4171-2.228-.0595-1.2645-.072-1.6442-.079-4.848-.007-3.2037.0053-3.583.0607-4.848.05-1.169.2456-1.805.408-2.2282.216-.5613.4762-.96.895-1.3816.4188-.4217.8184-.6814 1.3783-.9003.423-.1651 1.0575-.3614 2.227-.4171 1.2655-.06 1.6447-.072 4.848-.079 3.2033-.007 3.5835.005 4.8495.0608 1.169.0508 1.8053.2445 2.228.408.5608.216.96.4754 1.3816.895.4217.4194.6816.8176.9005 1.3787.1653.4217.3617 1.056.4169 2.2263.0602 1.2655.0739 1.645.0796 4.848.0058 3.203-.0055 3.5834-.061 4.848-.051 1.17-.245 1.8055-.408 2.2294-.216.5604-.4763.96-.8954 1.3814-.419.4215-.8181.6811-1.3783.9-.4224.1649-1.0577.3617-2.2262.4174-1.2656.0595-1.6448.072-4.8493.079-3.2045.007-3.5825-.006-4.848-.0608M16.953 5.5864A1.44 1.44 0 1 0 18.39 4.144a1.44 1.44 0 0 0-1.437 1.4424M5.8385 12.012c.0067 3.4032 2.7706 6.1557 6.173 6.1493 3.4026-.0065 6.157-2.7701 6.1506-6.1733-.0065-3.4032-2.771-6.1565-6.174-6.1498-3.403.0067-6.156 2.771-6.1496 6.1738M8 12.0077a4 4 0 1 1 4.008 3.9921A3.9996 3.9996 0 0 1 8 12.0077'/%3E%3C/svg%3E&#34;)" class=icon></i> <span>Instagram</span> </a><li><a rel=" me" href=https://mastodon.social title=Mastodon> <i style="--icon:url(&#34;data:image/svg+xml,%3Csvg role='img' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Ctitle%3EMastodon%3C/title%3E%3Cpath d='M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054c1.517.363 3.072.546 4.632.546.376 0 .75 0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23 0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112 0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311 0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13 0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z'/%3E%3C/svg%3E&#34;)" class=icon></i> <span>Mastodon</span> </a></ul></footer>